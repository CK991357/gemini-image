
# 更新日志：AI 智能编辑功能

**版本:** 1.0.0
**日期:** 2025-09-04

本次重大更新为应用添加了全新的“AI 智能编辑”功能，允许用户通过绘制蒙版和输入文本指令，对图片的特定区域进行精准的AI修改。

---

## 1. 新增功能：AI 智能编辑

-   **区域编辑**: 用户可以上传一张图片，使用可调节大小的**画笔**在图片上绘制蒙版，指定需要编辑的区域。
-   **橡皮擦工具**: 提供**橡皮擦**工具，用于精确修改蒙版区域。
-   **文本指令**: 用户可以输入自然的文本指令（例如，“把天空变成金色”或“给这个人戴上墨镜”），AI将根据指令和蒙版区域对图片进行修改。
-   **交互式画布**:
    -   基于 `Konva.js` 库构建，提供了流畅的绘制体验。
    -   支持画布的**缩放**和**平移**，方便处理大图或细节区域。
    -   画布和工具栏状态实时同步，用户体验友好（例如，无图时禁用工具）。

## 2. 架构与文件结构变更

为了保持代码的整洁和可维护性，新功能采用了模块化的架构：

-   **新建 `editor/` 目录**: 所有与AI智能编辑功能相关的逻辑都被封装在这个目录中。
    -   `editor/editor.js`: 作为功能的**主控制器**，负责处理UI事件、协调其他模块。
    -   `editor/canvas.js`: **画布模块**，封装了所有与 `Konva.js` 相关的操作，包括图片加载、绘制、缩放、平移以及导出图像和蒙版。
    -   `editor/api.js`: **API通信模块**，负责将处理好的数据（原图、蒙版、指令）发送到后端API端点。
    -   `editor/ui.js`: (已创建但当前为空) 为未来可能的复杂UI逻辑预留。

-   **`index.html` 更新**:
    -   添加了新的“AI智能编辑”功能切换按钮和对应的面板 (`#imageEditPanel`)。
    -   在主页面引入了 `Konva.js` 库的CDN链接。
    -   通过 `<script type="module">` 引入了 `editor/editor.js`，启动新功能。

## 3. 核心技术实现

-   **前端框架/库**:
    -   **Vanilla JavaScript (ES6 Modules)**: 用于组织代码，实现模块化。
    -   **Konva.js**: 用于构建高性能的交互式HTML5 Canvas画布。

-   **工作流程**:
    1.  用户在 `index.html` 上传图片。
    2.  `editor.js` 捕获事件，调用 `canvas.js` 中的

---

# 版本 1.1.0: API 迁移与 Bug 修复

**日期:** 2025-09-07

本次更新主要集中在后端 API 架构的现代化升级以及对 AI 智能编辑功能的多个关键 Bug 修复，显著提升了应用的稳定性和用户体验。

## 1. 核心架构升级：API 中转与模型统一

-   **弃用 OpenRouter**: 已完全移除对 OpenRouter 的依赖。之前通过 `functions/api/openrouter.js` 代理的调用逻辑已被废弃。
-   **引入自托管代理 (Cloudflare Worker)**: 所有对 Google Gemini API 的请求现在都通过一个统一的、自托管的 Cloudflare Worker 进行中转。这为 API 密钥管理和未来扩展提供了更稳定、更安全、更可控的解决方案。
-   **模型统一**: 应用中的所有 AI 图像相关功能（包括 OCR 文本识别和 AI 智能编辑）现在都统一使用 `gemini-2.5-flash-image-preview` 模型，简化了后端逻辑。

## 2. Bug 修复

-   **修复移动端滑动冲突**: 解决了在 AI 编辑器中，为防止页面滚动而设置的触摸锁定范围过大，导致画笔大小等滑块控件在手机上无法通过手指滑动调整的问题。现在，滑动锁定被精确地限制在画布区域内，改善了移动端操作体验。
-   **修复图片导出黑边问题**: 从根源上解决了 AI 编辑器保存图片时会带有黑色背景/边框的问题。通过修正向 AI 发送数据 (`exportLayersAsDataURL`) 和最终保存 (`exportImageLayerAsDataURL`) 两个环节的导出逻辑，确保在所有步骤中都只处理和保存干净、无黑边的图片内容，同时完整保留了精确位置编辑功能。

## 3. 其他变更

-   **UI 默认模型**: 主页图片生成功能的模型选项，现在默认选中 `gemini-2.5-flash-image-preview`。
-   **代码清理**: 已删除不再使用的后端代理文件 `functions/api/image-edit.js` 和 `functions/api/openrouter.js`。